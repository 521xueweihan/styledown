#!/usr/bin/env node
var meow = require('meow')
var styledown = require('../index')
var read = require('read-input')
var fs = require('fs')
var path = require('path')

var cli = require('meow')([
  'Usage:',
  '  $ styledown FILES...',
  '',
  'Output formats:',
  '      --json              parse into JSON data (default)',
  '      --yaml              parse into YAML data',
  '  -H, --html              render as HTML',
  '',
  'Parsing options:',
  '  -t, --transform LANG    transpiles examples of given LANG',
  '',
  'Rendering options:',
  '  -l, --layout FILE       uses FILE as an HTML layout',
  '  -o, --outdir DIR        render output HTML to DIR (implies --html)',
  '',
  'Other options:',
  '  -h, --help              show usage information',
  '  -v, --version           print version info and exit',
  '',
  'Examples:',
  '',
  '  styledown styles.md > styles.json         # parse to json',
  '  styledown styles.md --html > styles.html  # render to html',
  '  styledown *.md -o outdir                  # render to html (multiple)',
  '',
  "  styledown *.md -t jade    # transpiles 'example.jade' sections"
].join('\n'), {
  boolean: ['help', 'version', 'yaml', 'json', 'html'],
  string: ['format', 'transform', 'outdir'],
  alias: {
    h: 'help', v: 'version', H: 'html', t: 'transform', o: 'outdir'
  }
})

// Implied options
if (cli.flags.outdir) cli.flags.html = true
if (typeof cli.flags.transform === 'string') {
  cli.flags.transform = [cli.flags.transform]
}

read(cli.input)
.then(function (res) {
  res.files.forEach(function (file) {
    if (file.error) throw file.error
  })
  var output = styledown.parse(res.files, {
    transform: cli.flags.transform
  })

  if (cli.flags.outdir) {
    var dir = cli.flags.outdir
    require('mkdirp').sync(dir)
    Object.keys(output.files).forEach(function (fname) {
      fs.writeFileSync(
        path.join(dir, fname).replace(/\.md$/, '.html'),
        styledown.render(output, fname), 'utf-8')
    })
  } else if (cli.flags.html) {
    Object.keys(output.files).forEach(function (fname) {
      process.stdout.write(styledown.render(output, fname))
    })
  } else if (cli.flags.yaml) {
    console.log(require('js-yaml').safeDump(output))
  } else {
    console.log(JSON.stringify(output, null, 2))
  }
})
