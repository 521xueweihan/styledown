#!/usr/bin/env node
var Styledown = require('..'),
    read = require('read-input');

var args = require('minimist')(process.argv.slice(2), {
  boolean: ['inline', 'css', 'js', 'conf', 'quiet'],
  alias: { h: 'help', v: 'version', i: 'inline', o: 'output', q: 'quiet' }
});

if (args.help) {
  console.log([
      'Usage:',
      '    styledown [options] FILE',
      '    ... | styledown [options]',
      '    styledown --css > styledown.css',
      '',
      'Options:',
      '    -h, --help           print usage information',
      '    -v, --version        show version info and exit',
      '    -i, --inline         force extracts from inline CSS comments (for piping)',
      '    -o, --output FILE    write output a file',
      '',
      'Printing default files:',
      '        --conf           prints the default configuration file',
      '        --css            prints the default CSS',
      '        --js             prints the default JS',
  ].join('\n'));
  process.exit();
}

if (args.version) {
  console.log(require('../package.json').version);
  process.exit();
}

if (args.js) {
  process.stdout.write(Styledown.defaults.js());
  process.exit();
}

if (args.css) {
  process.stdout.write(Styledown.defaults.css());
  process.exit();
}

if (args.conf) {
  process.stdout.write(Styledown.defaults.conf());
  process.exit();
}

read(args._, function (err, res) {
  var html;

  var ms = measure(function () {
    html = Styledown.parse(res.files, {
      inline: args.inline
    }) + "\n";
  });

  if (args.output) {
    require('fs').writeFileSync(args.output, html);
    if (!args.quiet)
      process.stderr.write('' + args.output + " [" + ms + "ms]\n");
  } else {
    process.stdout.write(html);
  }
});

function measure (fn) {
  var d = new Date();
  fn();
  return new Date() - d;
}

